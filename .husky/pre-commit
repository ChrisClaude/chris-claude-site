#!/bin/sh

# Portable Husky hook for GitHub Desktop + Terminal

# 1. Ensure we can find local project binaries
export PATH="$(pwd)/node_modules/.bin:$PATH"

# 2. Try to locate Node if GitHub Desktop stripped it from PATH
if ! command -v node >/dev/null 2>&1; then
  # Find global node path
  NODE_PATH=$(command -v node || true)
  if [ -z "$NODE_PATH" ]; then
    # Try common install locations (Homebrew, NVM)
    for p in /opt/homebrew/bin/node /usr/local/bin/node "$HOME/.nvm/versions/node"/*/bin/node; do
      if [ -x "$p" ]; then
        export PATH="$(dirname "$p"):$PATH"
        break
      fi
    done
  else
    export PATH="$(dirname "$NODE_PATH"):$PATH"
  fi
fi

# 3. Fail early if Node is still missing
if ! command -v node >/dev/null 2>&1; then
  echo "❌ Error: Node.js is not available in PATH. Install it to run hooks."
  exit 1
fi

echo "🔍 Running pre-commit checks..."

# 4. Run lint-staged to format and lint staged files
echo "📝 Formatting and linting staged files..."
npm run pre-commit

# 5. Run type checking
echo "🔍 Running TypeScript type checking..."
npm run type-check

# 6. Run build check
echo "🏗️  Running build check..."
npm run build

echo "✅ All pre-commit checks passed!"
