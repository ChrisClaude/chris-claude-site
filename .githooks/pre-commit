#!/bin/sh

# Pre-commit hook for .NET solution and frontend
# This hook runs dotnet build, dotnet test, and frontend build before allowing a commit

echo "Running pre-commit checks..."

# Get the root directory of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)

# ==========================================
# Backend checks (.NET)
# ==========================================
echo "\nüîß Backend checks..."
cd "$ROOT_DIR/backend" || exit 1

# Run dotnet build
echo "Running dotnet build..."
dotnet build ChrisClaude.sln --no-restore
BUILD_RESULT=$?

if [ $BUILD_RESULT -ne 0 ]; then
  echo "‚ùå Backend build failed. Commit aborted."
  exit 1
fi

echo "‚úÖ Backend build succeeded."

# Run dotnet test
echo "Running dotnet test..."
dotnet test ChrisClaude.sln --no-build --verbosity quiet
TEST_RESULT=$?

if [ $TEST_RESULT -ne 0 ]; then
  echo "‚ùå Backend tests failed. Commit aborted."
  exit 1
fi

echo "‚úÖ Backend tests passed."

# ==========================================
# Frontend checks
# ==========================================
echo "\nüé® Frontend checks..."
cd "$ROOT_DIR/frontend" || exit 1

# Run pnpm build
echo "Running pnpm run build..."
pnpm run build
FRONTEND_BUILD_RESULT=$?

if [ $FRONTEND_BUILD_RESULT -ne 0 ]; then
  echo "‚ùå Frontend build failed. Commit aborted."
  exit 1
fi

echo "‚úÖ Frontend build succeeded."

# ==========================================
# All checks passed
# ==========================================
echo "\n‚úÖ All pre-commit checks passed. Proceeding with commit..."

exit 0
